import{q as N,r as i,j as e,a as b}from"./utils-eb5efc80.js";import{C as w,a as _,M as y,L as S,S as M}from"./ServerIdLayout-c07dd259.js";import{u as R,S as k,C as L,a as F}from"./index-2fc7bd59.js";import{L as C}from"./loader-2-0ed0f1f3.js";import{u as I}from"./app-cacaf052.js";import{C as P}from"./module-63751d3c.js";import"./react-drag-drop-files.esm-41bf0066.js";import"./index-ae8a64b4.js";import"./chevron-down-2d7ba327.js";import"./button-3cb7bb48.js";import"./alert-0236938e.js";import"./upload-cloud-5d69c1a3.js";import"./alert-circle-b44fd1a9.js";import"./loader-ffea248d.js";const D=({getMsgsRoute:r,type:t})=>{var f,j;const{current_channel:o,auth:d}=N().props;if(!o)return null;const h=i.useRef(null),l=i.useRef(null),{data:s,fetchNextPage:n,hasNextPage:c,isFetchingNextPage:a,status:u}=R({queryRoute:r,queryKey:`channel_${o.id.toString()}`,value:"0"}),m=()=>{if(!(s!=null&&s.pages))return null;n()},p=s==null?void 0:s.pages;return i.useEffect(()=>{setTimeout(()=>{var x;return(x=l.current)==null?void 0:x.scrollIntoView({behavior:"smooth",block:"center"})},100)},[l,(j=(f=s==null?void 0:s.pages)==null?void 0:f[0])==null?void 0:j.data]),u==="loading"?e.jsxs("div",{className:"flex flex-col flex-1 justify-center items-center",children:[e.jsx(C,{className:"h-7 w-7 text-neutral-500 animate-spin my-3.5"}),e.jsx("p",{className:"text-xs",children:"Loading Messages..."})]}):u==="error"?e.jsxs("div",{className:"flex flex-col flex-1 justify-center items-center",children:[e.jsx(k,{className:"h-7 w-7 text-neutral-500 my-3.5"}),e.jsx("p",{className:"text-xs",children:"Server Error"})]}):e.jsxs("div",{ref:h,className:"flex-1 flex flex-col py-3.5 overflow-y-auto",children:[!c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1"}),e.jsx(L,{type:t,name:o.name})]}),c&&e.jsx("div",{className:"flex justify-center",children:a?e.jsx(C,{className:"h-6 w-6 text-neutral-600 animate-ping"}):e.jsx("button",{onClick:m,className:"text-neutral-500 hover:text-neutral-600 dark:text-neutral-400 dark:hover:text-neutral-300 transition text-xs",children:"Load Previous Messages..."})}),e.jsx("div",{className:"flex flex-col-reverse mt-auto",children:p==null?void 0:p.map((x,E)=>{var g;return e.jsx(i.Fragment,{children:(g=x.data)==null?void 0:g.map(v=>e.jsx(w,{type:t,message:v},v.id))},E)})}),e.jsx("div",{className:"p-8",hidden:!o.feedback_comment,children:e.jsxs("div",{className:"p-4 bg-gray-200 dark:bg-gray-700 rounded-md",children:[e.jsx("p",{className:"font-bold mb-4",children:"USER FEEDBACK / COMMENT"}),e.jsx("p",{className:"bg-gray-200 dark:bg-gray-700 text-sm",children:o.feedback_comment})]})}),e.jsx("div",{ref:l})]})},q=()=>{const{current_server:r,current_channel:t,auth:o}=N().props,d=I();if(i.useEffect(()=>{if(t)return window.Echo.join("channel_"+t.id.toString()).listen("NewChatMessageEvent",({message:s})=>{d.setQueryData([`channel_${t.id.toString()}`],n=>{const{pages:c}=n,a=c;return a[0]={...a[0],data:[s,...a[0].data]},{...n,pages:a}})}).listen("MessageUpdateEvent",({message:s})=>{d.setQueryData([`channel_${t.id.toString()}`],n=>{const{pages:c}=n,a=c;return a[0]={...a[0],data:a[0].data.map(m=>m.id!==s.id?m:s)},{...n,pages:a}})}),()=>window.Echo.leaveAllChannels()},[t==null?void 0:t.id,d]),!t)return null;const h=i.useMemo(()=>route("server.channel.message.store",{server_id:r.id,channel_id:t.id}),[r.id,t.id]),l=i.useMemo(()=>route("server.channel.message.index",{server_id:r.id,channel_id:t.id}),[r.id,t.id]);return e.jsxs("div",{className:"bg-white dark:bg-neutral-950 flex flex-col h-full",children:[e.jsx(_,{name:t.name,server:r,channel:t,type:"Channel"}),t.type==="TEXT"&&e.jsxs(e.Fragment,{children:[e.jsx(D,{getMsgsRoute:l,type:"Channel"}),e.jsx(F,{getMsgsRoute:l,name:t.name,type:"Channel",apiRoute:h})]}),t.type==="AUDIO"&&e.jsx(y,{chat_id:t.id.toString(),audio:!0}),t.type==="VIDEO"&&e.jsx(y,{chat_id:t.id.toString(),video:!0})]})},J=()=>e.jsxs(e.Fragment,{children:[e.jsx(b,{title:"Chat"}),e.jsx(P,{children:e.jsx(S,{children:e.jsx(M,{children:e.jsx(q,{})})})})]});export{J as default};
