import{r as c,q as m,j as e,a as M}from"./utils-64caab42.js";import{C as E,a as S,M as _,L,S as R}from"./ServerIdLayout-7593fd54.js";import{u as b,L as y,S as P,C as k,a as F}from"./index-36b4c578.js";import{u as I}from"./index-3c7254c7.js";import{C as T}from"./module-cdae6d27.js";import{u as q}from"./app-354e0870.js";import"./react-drag-drop-files.esm-b088b8bd.js";import"./alert-7fe151e9.js";import"./upload-cloud-365b74f1.js";import"./alert-circle-1273824c.js";import"./loader-f5ec6bed.js";import"./chevron-down-6a0284dd.js";const Q=o=>{const{chatRef:t,bottomRef:i,shouldLoadMore:a,loadMore:l,count:n}=o;c.useState(!1),c.useEffect(()=>{const r=t.current,s=()=>{(r==null?void 0:r.scrollTop)===0&&a&&l()};return r==null||r.addEventListener("scroll",s),()=>r==null?void 0:r.removeEventListener("scroll",s)},[a,l,t]),c.useEffect(()=>{setTimeout(()=>{var r;return(r=i.current)==null?void 0:r.scrollIntoView({behavior:"smooth",block:"center"})},100)},[i,n])},V=({getMsgsRoute:o,type:t,otherUser:i})=>{var p,j;const{current_conversation:a,auth:l}=m().props;if(!a)return null;const n=c.useRef(null),r=c.useRef(null),{data:s,fetchNextPage:u,hasNextPage:d,isFetchingNextPage:f,status:h}=b({queryRoute:o,queryKey:`channel_${a.id.toString()}`,value:"0"}),v=()=>{if(!(s!=null&&s.pages))return null;u()};Q({chatRef:n,bottomRef:r,loadMore:v,shouldLoadMore:!f&&!!d,count:((j=(p=s==null?void 0:s.pages)==null?void 0:p[0])==null?void 0:j.data.length)??0});const x=s==null?void 0:s.pages;return h==="loading"?e.jsxs("div",{className:"flex flex-col flex-1 justify-center items-center",children:[e.jsx(y,{className:"h-7 w-7 text-neutral-500 animate-spin my-3.5"}),e.jsx("p",{className:"text-xs",children:"Loading Messages..."})]}):h==="error"?e.jsxs("div",{className:"flex flex-col flex-1 justify-center items-center",children:[e.jsx(P,{className:"h-7 w-7 text-neutral-500 my-3.5"}),e.jsx("p",{className:"text-xs",children:"Server Error"})]}):e.jsxs("div",{ref:n,className:"flex-1 flex flex-col py-3.5 overflow-y-auto",children:[!d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1"}),e.jsx(k,{type:t,name:i.name})]}),d&&e.jsx("div",{className:"flex justify-center",children:f?e.jsx(y,{className:"h-6 w-6 text-neutral-600 animate-ping"}):e.jsx("button",{onClick:v,className:"text-neutral-500 hover:text-neutral-600 dark:text-neutral-400 dark:hover:text-neutral-300 transition text-xs",children:"Load Previous Messages..."})}),e.jsx("div",{className:"flex flex-col-reverse mt-auto",children:x==null?void 0:x.map((N,w)=>{var g;return e.jsx(c.Fragment,{children:(g=N.data)==null?void 0:g.map(C=>e.jsx(E,{type:t,message:C},C.id))},w)})}),e.jsx("div",{ref:r})]})},$=()=>{const{current_server:o,current_conversation:t,auth:i}=m().props,{user:a}=i,{isVideo:l,conversationId:n}=I();if(!t)return null;const r=c.useMemo(()=>route("server.conversation.store",{server_id:o.id,conversation_id:t.id}),[o.id,t.id]),s=c.useMemo(()=>route("server.conversation.show",{server_id:o.id,conversation_id:t.id}),[o.id,t.id]),u=c.useMemo(()=>a.id!==t.initiator.id?t.initiator:t.reciever,[t]);return c.useEffect(()=>console.log(s),[s]),e.jsxs("div",{className:"bg-white dark:bg-neutral-950 flex flex-col h-full",children:[e.jsx(S,{name:u.name,user:u,server:o,type:"Conversation"}),l&&n===t.id?e.jsx(_,{chat_id:t.id.toString(),video:!0,audio:!0}):e.jsxs(e.Fragment,{children:[e.jsx(V,{otherUser:u,getMsgsRoute:s,type:"Conversation"}),e.jsx(F,{getMsgsRoute:s,name:u.name,apiRoute:r,type:"Conversation"})]})]})},Z=()=>{const{current_conversation:o}=m().props,t=q();return c.useEffect(()=>{if(o)return window.Echo.join("conversation_"+o.id.toString()).listen("NewDirectMessageEvent",({direct_message:i})=>{t.setQueryData([`channel_${o.id.toString()}`],a=>{const{pages:l}=a,n=l;return n[0]={...n[0],data:[i,...n[0].data]},{...a,pages:n}})}).listen("DMUpdateEvent",({direct_message:i})=>{t.setQueryData([`channel_${o.id.toString()}`],a=>{const{pages:l}=a,n=l;return n[0]={...n[0],data:n[0].data.map(s=>s.id!==i.id?s:i)},{...a,pages:n}})}),()=>window.Echo.leaveAllChannels()},[o==null?void 0:o.id,t]),e.jsxs(e.Fragment,{children:[e.jsx(M,{title:"Conversation"}),e.jsx(T,{children:e.jsx(L,{children:e.jsx(R,{children:e.jsx($,{})})})})]})};export{Z as default};
