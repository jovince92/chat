import{q as x,r as l,j as e,a as S}from"./utils-d51774f8.js";import{C as _,a as M,M as y,L as E,S as L}from"./ServerIdLayout-65ea8da0.js";import{u as R,a as P,L as C,S as b,C as F,b as I}from"./useChatScroll-827c7ac5.js";import{C as k}from"./module-7887c94f.js";import{u as q}from"./app-893070f3.js";import"./react-drag-drop-files.esm-082b0a5e.js";import"./index-536976de.js";import"./chevron-down-0c4ee3ec.js";import"./alert-1d33a961.js";import"./upload-cloud-377c13ba.js";import"./alert-circle-f5d1043f.js";import"./loader-918b2076.js";const D=({getMsgsRoute:s,type:t})=>{var f,j;const{current_channel:n,auth:i}=x().props;if(!n)return null;const o=l.useRef(null),a=l.useRef(null),{data:r,fetchNextPage:c,hasNextPage:u,isFetchingNextPage:h,status:m}=R({queryRoute:s,queryKey:`channel_${n.id.toString()}`,value:"0"}),p=()=>{if(!(r!=null&&r.pages))return null;c()};P({chatRef:o,bottomRef:a,loadMore:p,shouldLoadMore:!h&&!!u,count:((j=(f=r==null?void 0:r.pages)==null?void 0:f[0])==null?void 0:j.data.length)??0});const d=r==null?void 0:r.pages;return m==="loading"?e.jsxs("div",{className:"flex flex-col flex-1 justify-center items-center",children:[e.jsx(C,{className:"h-7 w-7 text-neutral-500 animate-spin my-3.5"}),e.jsx("p",{className:"text-xs",children:"Loading Messages..."})]}):m==="error"?e.jsxs("div",{className:"flex flex-col flex-1 justify-center items-center",children:[e.jsx(b,{className:"h-7 w-7 text-neutral-500 my-3.5"}),e.jsx("p",{className:"text-xs",children:"Server Error"})]}):e.jsxs("div",{ref:o,className:"flex-1 flex flex-col py-3.5 overflow-y-auto",children:[!u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1"}),e.jsx(F,{type:t,name:n.name})]}),u&&e.jsx("div",{className:"flex justify-center",children:h?e.jsx(C,{className:"h-6 w-6 text-neutral-600 animate-ping"}):e.jsx("button",{onClick:p,className:"text-neutral-500 hover:text-neutral-600 dark:text-neutral-400 dark:hover:text-neutral-300 transition text-xs",children:"Load Previous Messages..."})}),e.jsx("div",{className:"flex flex-col-reverse mt-auto",children:d==null?void 0:d.map((N,w)=>{var g;return e.jsx(l.Fragment,{children:(g=N.data)==null?void 0:g.map(v=>e.jsx(_,{type:t,message:v},v.id))},w)})}),e.jsx("div",{ref:a})]})},Q=()=>{const{current_server:s,current_channel:t,auth:n}=x().props;if(!t)return null;const i=l.useMemo(()=>route("server.channel.message.store",{server_id:s.id,channel_id:t.id}),[s.id,t.id]),o=l.useMemo(()=>route("server.channel.message.index",{server_id:s.id,channel_id:t.id}),[s.id,t.id]);return e.jsxs("div",{className:"bg-white dark:bg-neutral-950 flex flex-col h-full",children:[e.jsx(M,{name:t.name,server:s,type:"Channel"}),t.type==="TEXT"&&e.jsxs(e.Fragment,{children:[e.jsx(D,{getMsgsRoute:o,type:"Channel"}),e.jsx(I,{name:t.name,type:"Channel",apiRoute:i})]}),t.type==="AUDIO"&&e.jsx(y,{chat_id:t.id.toString(),audio:!0}),t.type==="VIDEO"&&e.jsx(y,{chat_id:t.id.toString(),video:!0})]})},G=()=>{const{current_channel:s}=x().props,t=q();return l.useEffect(()=>{if(s)return window.Echo.join("channel_"+s.id.toString()).listen("NewChatMessageEvent",({message:n})=>{t.setQueryData([`channel_${s.id.toString()}`],i=>{const{pages:o}=i,a=o;return a[0]={...a[0],data:[n,...a[0].data]},{...i,pages:a}})}).listen("MessageUpdateEvent",({message:n})=>{t.setQueryData([`channel_${s.id.toString()}`],i=>{const{pages:o}=i,a=o;return a[0]={...a[0],data:a[0].data.map(c=>c.id!==n.id?c:n)},{...i,pages:a}})}),()=>window.Echo.leaveAllChannels()},[s==null?void 0:s.id,t]),e.jsxs(e.Fragment,{children:[e.jsx(S,{title:"Chat"}),e.jsx(k,{children:e.jsx(E,{children:e.jsx(L,{children:e.jsx(Q,{})})})})]})};export{G as default};
