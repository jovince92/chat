import{q as m,r as i,j as e,a as _}from"./utils-f4136f34.js";import{C as M,a as S,M as E,L,S as R}from"./ServerIdLayout-c3ea340e.js";import{u as P,a as b,L as y,S as F,C as k,b as q}from"./useChatScroll-c04fe51f.js";import{u as D}from"./index-256adb21.js";import{C as I}from"./module-c4ed8ba0.js";import{u as Q}from"./app-e0d0c5e8.js";import"./react-drag-drop-files.esm-91de88e7.js";import"./alert-4dc833a2.js";import"./upload-cloud-c3ceee65.js";import"./alert-circle-af391df8.js";import"./loader-8c026fc1.js";import"./chevron-down-e7131a9a.js";const $=({getMsgsRoute:r,type:t,otherUser:o})=>{var p,j;const{current_conversation:n,auth:l}=m().props;if(!n)return null;const a=i.useRef(null),c=i.useRef(null),{data:s,fetchNextPage:u,hasNextPage:d,isFetchingNextPage:h,status:v}=P({queryRoute:r,queryKey:`channel_${n.id.toString()}`,value:"0"}),f=()=>{if(!(s!=null&&s.pages))return null;u()};b({chatRef:a,bottomRef:c,loadMore:f,shouldLoadMore:!h&&!!d,count:((j=(p=s==null?void 0:s.pages)==null?void 0:p[0])==null?void 0:j.data.length)??0});const x=s==null?void 0:s.pages;return v==="loading"?e.jsxs("div",{className:"flex flex-col flex-1 justify-center items-center",children:[e.jsx(y,{className:"h-7 w-7 text-neutral-500 animate-spin my-3.5"}),e.jsx("p",{className:"text-xs",children:"Loading Messages..."})]}):v==="error"?e.jsxs("div",{className:"flex flex-col flex-1 justify-center items-center",children:[e.jsx(F,{className:"h-7 w-7 text-neutral-500 my-3.5"}),e.jsx("p",{className:"text-xs",children:"Server Error"})]}):e.jsxs("div",{ref:a,className:"flex-1 flex flex-col py-3.5 overflow-y-auto",children:[!d&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex-1"}),e.jsx(k,{type:t,name:o.name})]}),d&&e.jsx("div",{className:"flex justify-center",children:h?e.jsx(y,{className:"h-6 w-6 text-neutral-600 animate-ping"}):e.jsx("button",{onClick:f,className:"text-neutral-500 hover:text-neutral-600 dark:text-neutral-400 dark:hover:text-neutral-300 transition text-xs",children:"Load Previous Messages..."})}),e.jsx("div",{className:"flex flex-col-reverse mt-auto",children:x==null?void 0:x.map((N,w)=>{var g;return e.jsx(i.Fragment,{children:(g=N.data)==null?void 0:g.map(C=>e.jsx(M,{type:t,message:C},C.id))},w)})}),e.jsx("div",{ref:c})]})},U=()=>{const{current_server:r,current_conversation:t,auth:o}=m().props,{user:n}=o,{isVideo:l,conversationId:a}=D();if(!t)return null;const c=i.useMemo(()=>route("server.conversation.store",{server_id:r.id,conversation_id:t.id}),[r.id,t.id]),s=i.useMemo(()=>route("server.conversation.show",{server_id:r.id,conversation_id:t.id}),[r.id,t.id]),u=i.useMemo(()=>n.id!==t.initiator.id?t.initiator:t.reciever,[t]);return i.useEffect(()=>console.log(s),[s]),e.jsxs("div",{className:"bg-white dark:bg-neutral-950 flex flex-col h-full",children:[e.jsx(S,{name:u.name,user:u,server:r,type:"Conversation"}),l&&a===t.id?e.jsx(E,{chat_id:t.id.toString(),video:!0,audio:!0}):e.jsxs(e.Fragment,{children:[e.jsx($,{otherUser:u,getMsgsRoute:s,type:"Conversation"}),e.jsx(q,{name:u.name,apiRoute:c,type:"Conversation"})]})]})},Y=()=>{const{current_conversation:r}=m().props,t=Q();return i.useEffect(()=>{if(r)return window.Echo.join("conversation_"+r.id.toString()).listen("NewDirectMessageEvent",({direct_message:o})=>{t.setQueryData([`channel_${r.id.toString()}`],n=>{const{pages:l}=n,a=l;return a[0]={...a[0],data:[o,...a[0].data]},{...n,pages:a}})}).listen("DMUpdateEvent",({direct_message:o})=>{t.setQueryData([`channel_${r.id.toString()}`],n=>{const{pages:l}=n,a=l;return a[0]={...a[0],data:a[0].data.map(s=>s.id!==o.id?s:o)},{...n,pages:a}})}),()=>window.Echo.leaveAllChannels()},[r==null?void 0:r.id,t]),e.jsxs(e.Fragment,{children:[e.jsx(_,{title:"Conversation"}),e.jsx(I,{children:e.jsx(L,{children:e.jsx(R,{children:e.jsx(U,{})})})})]})};export{Y as default};
